<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>友利奈緒とコミュニケーションするアプリ - 純粋関数空間</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="../css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
    <link href="../css/default.css" rel="stylesheet" media="screen">
    <link href="../css/syntax.css" rel="stylesheet" media="screen">
    <link href="../css/docs.css" rel="stylesheet" media="screen">

    <script type="text/javascript" src="http://s.hatena.ne.jp/js/HatenaStar.js"></script>
    <script type="text/javascript">
        Hatena.Star.Token = '448676af7a3fe5b6511e9789fbaed5a26da61054';
        Hatena.Star.SiteConfig = {
            entryNodes: {
                '.post-title': {
                    uri: 'document.location',
                    title: 'document.title',
                    container: 'parent'
                }
            }
        };
    </script>
  </head>
  <body>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="../js/bootstrap.min.js"></script>

    <div class="container-fluid">
        <div class="navbar">
            <div class="navbar-inner">
                <a class="brand" href="../">tanakh.jp</a>

                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>

                <div class="nav-collapse">
                    <ul class="nav">
                        <li><a href="../">Home</a></li>
                        <li><a href="../about.html">About</a></li>
                        <li><a href="../contact.html">Contact</a></li>
                        <li><a href="../pub.html">Publications</a></li>
                        <li><a href="../tools.html">Tools</a></li>
                        <li><a href="../archive.html">Archive</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row-fluid">
            <div class="span2"></div>
            <div class="span8">
                <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<h2 class="post-title">友利奈緒とコミュニケーションするアプリ</h2>

<p>
  <div class="info">Posted on December 20, 2015, Tags: <a href="../tags/haskell.html">haskell</a></div>
</p>

<!-- Social Buttons -->
<div class="social">
    <div class="hatena">
        <a href="http://b.hatena.ne.jp/entry/tanakh.jp/posts/2015-12-20-tomori-nao.html" class="hatena-bookmark-button" data-hatena-bookmark-title="友利奈緒とコミュニケーションするアプリ - tanakh.jp" data-hatena-bookmark-layout="standard-balloon" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    </div>
    <div class="facebook">
        <div class="fb-like" data-href="http://tanakh.jp/posts/2015-12-20-tomori-nao.html" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" data-font="arial"></div>
    </div>
    <div class="gplus">
        <!-- +1 ボタン を表示したい位置に次のタグを貼り付けてください。 -->
        <div class="g-plusone" data-size="medium" data-href="http://tanakh.jp/posts/2015-12-20-tomori-nao.html"></div>
        <!-- 最後の +1 ボタン タグの後に次のタグを貼り付けてください。 -->
        <script type="text/javascript">
          (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
          })();
        </script>
    </div>
    <div class="twitter">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="tanakh" data-lang="ja">ツイート</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>
</div>

<hr>

<div class="post-content">
<p>これは <a href="http://www.adventar.org/calendars/779">友利奈緒 Advent Calendar 2015</a> の20日目の記事です。必死で未来から書いています。</p>
<h1 id="友利奈緒とコミュニケーションするアプリ">友利奈緒とコミュニケーションするアプリ</h1>
<p>のようなものを作りました。たぶん<a href="https://github.com/tanakh/tomorinask">この辺</a>にソースを置くと思います。バイナリはたぶんもうしばらくしたら配布するかもしれませんが、こんなツール使いたいと思う人があんまりいない気がするので、配布しないかもしれません。</p>
<p>追記：バイナリ配布しました。使ってみたいという奇特な方は、<a href="https://github.com/tanakh/tomorinask/releases" class="uri">https://github.com/tanakh/tomorinask/releases</a>こちらからお試しください。</p>
<h1 id="最近困っていたことaskリニューアル問題">最近困っていたこと：Askリニューアル問題</h1>
<p>ところで、<a href="https://ask.fm">Ask.fm</a> という、どこからともなく質問がたくさんやってくる謎のサービスがあるのですが、このサイトが先日デザインをリニューアルしました。それはそれでいいのですが、大幅にリニューアルされてしまったせいで、僕にとっては大変使いづらくなってしまいました。</p>
<p>僕のアカウントには日ごろから結構たくさん質問をいただいていて、そのほぼすべてに「古い順に」回答を書いているのですが、これが非常に面倒くさい。</p>
<p>まずAsk.fmの質問一覧を表示させると、「最新」25件だけが表示されます。それより古い質問は、一番下までスクロールさせると自動的にリロードされて、末尾にアペンドされる形になります。質問が数百件たまっているときにこれをやろうとすると、まず一番古い質問を表示させるためにマウスのホイールを延々何十秒かくるくるし続けなければなりません。</p>
<p>そのあと質問にある「回答」ボタンをクリックすると、今度は回答画面に遷移します。回答画面に遷移して頑張って面白い回答をうんうん唸りながらタイプして、それから送信ボタンを押すと今度はまた質問一覧の画面に遷移します。そして質問一覧の画面に遷移するということは、当然また先ほどのよう何十秒かマウスをクリクリしなければならないわけです。一体自分は質問の回答をしているのか、マウスの耐久テストをしているのか、とでも言いたくなるほどに面倒極まるタスクの繰り返しで、Askを作っている人はこういう使い方で問題ないと考えているのか、あるいはこんなヘビーユーザーがいることを想定していないのか、はたまた質問はFIFOじゃなくてスタックで処理しろとおっしゃっているのか、いずれにせよ僕にはちょっとしっくりこない操作だったわけです。</p>
<p>まあ、このユーザーインターフェース自体は以前とたいして変わらないし、むしろ質問をする側の使い勝手としては、右側に常に質問ボックスが表示される仕様になったので、改善といえるものなのかもしれません。しかし以前のバージョンでは、Ask.fm使いづらいなあとぼやいていたら、親切なaskerの人がCtrl+Enterで投稿→自動で次の質問に移動するとても便利なChrome拡張を作ってくださったので、それでとても素晴らしいAskライフを送っていたのでした。それが、今回のリニューアルでまた以前の状況に逆戻りです。これではとてもじゃないけど、数百の質問をさばくことなんてできません。しかもアレですよ。僕にやってくる質問なんて半分ぐらいブリブリ！とかそんな感じでなので、頑張ってマウスホイールをクリクリクリクリ延々と転がして、それで出てきた質問が、</p>
<div class="figure">
<img src="../img/posts/ask-fm.PNG" />

</div>
<p>こんなふううにﾌﾞﾁﾐﾘだった暁には、もうウインドウ閉じて眠りたくなりますよ。</p>
<h1 id="そこで友利奈緒">そこで友利奈緒</h1>
<p>そんなわけで僕のAskライフはとてもつらくなってしまいました。でも、変わらず質問を送ってくださる方はいらっしゃるので、それにお答えするのも使命ではあるなあと、重い腰を上げて使いやすいクライアントを作るか…となったわけです。そこで、せっかくだから、モチベを保つために、友利奈緒を導入することにしました。</p>
<p>どういうことかというと、Ask.fmにやってくる質問は大体が匿名質問なのです。だれが書いているかわからない質問だから、送信者を友利奈緒と思い込むことも可能だし、その可能性も実際にはまったくの0とは言えない。質問者を友利奈緒だと思い込むことによって、疑似的に友利奈緒とコミュニケーションしていると思い込むことも可能だし、そうすれば回答のモチベも多少上がるはず。加えて、プログラム書くモチベも上がるはず。</p>
<p>というわけで、こんなツールができました。イラストは<a href="https://twitter.com/yaplus">@yaplus</a>氏が配布されているものを使わせていただいています。ライセンス的に問題があったらすみません。消します。</p>
<div class="figure">
<img src="../img/posts/tomorisk1.png" />

</div>
<p>ログインすると、友利奈緒から質問がやってきます。チャットアプリ風にしてみたので、某所のりんなちゃんのように楽しめるのではなかろうか？しかも書いてるのはAIじゃなくて生身の人間です。</p>
<div class="figure">
<img src="../img/posts/tomorisk2.png" />

</div>
<p>しかし、質問がヒドいっ。</p>
<div class="figure">
<img src="../img/posts/tomorisk3.png" />

</div>
<p>回答欄にタイプしてCtrl+Enterするだけで次々友利奈緒から質問が来るので、サクサク質問に答えられます。圧倒的に楽。スパムが来た時はSkipで回答を保留できます。全部質問を消化した後も定期的にポーリングしているので、取得し次第質問が表示されます。しかしこれ、もうちょっと友利奈緒とコミュニケーションしている感が出るかなあと思ったのですが、口調が全然違う質問ばかりだし、下品なのが結構多いので、実際のところ「友利奈緒はこんなこと言わない…」という感想にしかならないのが悲しかったです。</p>
<h1 id="メイキング">メイキング</h1>
<h2 id="electron-ghcjs">Electron + GHCJS</h2>
<p>ところでこのプログラムですが、最近流行りのElectronで実装してみました。ブラウザでデスクトップアプリなんて（困惑）とは頭ではそう思いつつも、触らずになんだかんだいうのも…ということなので、せっかくなので使ってみることにしました。</p>
<p>しかしElectronはともかく、JavaScriptを書くのは死んでも嫌でござる！と僕の深層心理が激しい拒否を訴えてくるので、JavaScriptは書きませんでした。今の世の中、JavaScriptをターゲット言語にできる言語処理系はたくさんあるんです。僕はHaskell愛好家なので、もちろんGHCJSを使いました。</p>
<p>Haskellの開発環境は、ちょうど今年<a href="http://docs.haskellstack.org/">Stack</a>というツールの登場によってずいぶんいろいろと進展しました。僕も今年の夏ごろに記事を書いています（<a href="http://qiita.com/tanakh/items/6866d0f570d0547df026" class="uri">http://qiita.com/tanakh/items/6866d0f570d0547df026</a>）。</p>
<p>その進展の一つに、Stackを使うとGHCJSがものすごく簡単にセットアップできるというのがあります。今まではまずGHCJSのコンパイルとセットアップが結構面倒でこの時点で、もういいや…となってしまいそうなぐらいでしたが、今ではstackの設定ファイルに一つ設定を追加するだけです。<code>stack new</code>でGHCJS向けのプロジェクトテンプレートが生成できるし、あとは<code>stack build</code>コマンドでHaskellのコードがコンパイルされて.jsファイルが出来上がります。一昔前が信じられないぐらい楽ちんですね。</p>
<p>それから、Electronのサイトをみて、最初のサンプルを拾ってきます。あとは index.html から出来上がったjsファイルを読み込ませるだけです。これだけでHaskellでElectronアプリが書けました！</p>
<p>このあたりの詳細な手順も書き残しておこうと思うので、近いうちに詳しい記事を書こうと思います。</p>
<p>HaskellからJavaScriptを生成できるとはいえ、DOMをいじらなければブラウザのアプリにはならないので、そこの辺りはライブラリの話になります。当然のことながら、GHCJS向けのライブラリはほとんどまともに存在していないのですが、かろうじて<a href="https://hackage.haskell.org/package/ghcjs-dom">ghcjs-dom</a>というDOM操作ライブラリはちゃんと作られていたので、今回はまったくJavaScriptへのFFIを手で書かずにすみました。とはいえGHCJSではJavaScriptのFFIもそんなに大変だというわけではないのですが。</p>
<h2 id="haskellで書いてうれしかったこと">Haskellで書いてうれしかったこと</h2>
<p>HaskellでWebアプリを書くことに関しては、気づいただけでいくつかはっきりとしたメリットがありました。一つは、きっちりとした型がついていること。特にDOMのAPIに関しては、まったく知識がなかったにもかかわらず、APIのドキュメントを読むだけで特にはまることなく使い方も悩むことがなかったです。ただ一つ難を言えば、ドキュメントがでかいのと、Haddockの生成するHTMLがモジュールをまたいでいろいろ参照するのに便利にできてないので、結構閲覧がめんどかったということでしょうか。</p>
<p>別の利点としては、結構な数のHaskellのライブラリがGHCJSでそのまま動くということ。今回のケースでは<a href="http://hackage.haskell.org/package/parsec">parsec</a>や<a href="http://hackage.haskell.org/package/aeson">aeson</a>のような強力なパージングライブラリがつかえたことが大きかったです。そもそもJSONやHTMLをネイティブに扱えるJavaScriptでHaskellからコンパイルしたコードで自前でパーズするのがなんだかとても無駄な気もしますけど、もっと別の用途を考えると、可能性は感じました。</p>
<p>もう一つは、マルチスレッドコードが書けること。スレッドを立ててブロッキングで処理して、セマフォを使ってデータを受け渡しのようなコードがすっきり書けます。JavaScriptでは（ES6だとasync/awaitなどが入るようですが）コールバックが前提で、コードがわかりづらくなりやすいようですが、そういうのをまったく回避して、直接的なコードフローで見通しの良いコードが書けます。このアプリだと、質問を取得しているスレッドと、ユーザからの入力を待っているスレッドがあって、これらのスレッドがチャンネルを介して質問オブジェクトを受け渡ししています。</p>
<h2 id="electron所感">Electron所感</h2>
<p>Electronでデスクトップアプリを作ることに関しては、まあ何でしょうか。レイアウトなどは相変わらずしんどいのですが、HTML/CSSに関する情報はあまりにも世の中にたくさんありすぎます。Googleで検索してわからないことなどまずないでしょう。Webデザインなどほとんどやらない僕でも、なんかそれっぽい画面を作れてしまうのは、やっぱりHTMLだなあと思いました。WPFとかQtとかだとこうはいかない。なんだかちょっとつらいところはありますね。</p>
<h1 id="おわりに">おわりに</h1>
<p>そういうわけで、久々にGUIアプリを書いてみたのですが、結構やってみると面白いものですね。なんかネタを探してもっと何か作りたくなってきました。あと記事遅くなって申し訳ありませんでした。</p>
</div>

<br>

<script type="text/javascript"><!--
google_ad_client = "ca-pub-2554934724722249";
/* normal */
google_ad_slot = "6131209617";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

<br>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'tanakh-jp'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'tanakh-jp'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

            </div>
            <div class="span2"></div>
        </div>

        <hr>

        <footer class="footer">
            <center>
            <p>
                Copyright (c) 2011-2015, Hideyuki Tanaka (@<a href="https://twitter.com/tanakh">tanakh</a>)
            </p>
            <p>
                Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.<br>
                Served by <a href="http://mew.org/~kazu/proj/mighttpd/en/">Mighttpd2</a>.<br>
                Tools are made with <a href="http://fay-lang.org/">Fay</a>.<br>
                This site uses <a href="http://twitter.github.io/bootstrap/">Twitter Bootstrap</a>, and theme from <a href="http://bootswatch.com/">Bootswatch</a>.<br>
            <p>
            </center>
        </footer>
    </div>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-26679036-1']);
      _gaq.push(['_setDomainName', 'tanakh.jp']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>

  </body>
</html>
