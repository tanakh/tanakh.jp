<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><title>エラー処理を書いてはいけない</title><meta charset="utf-8"><script src="pfi-seminar-2011-12-08_files/slides.txt"></script><link rel="stylesheet" href="pfi-seminar-2011-12-08_files/syntax.css"><link rel="stylesheet" href="pfi-seminar-2011-12-08_files/style.css"><meta content="width=1100,height=750" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"></head><body class="loaded" style="display: none;"><section class="slides layout-regular template-pfi"><article class="past"><h1>エラー処理を書いてはいけない</h1><p>田中英行&nbsp;<a href="mailto:tanaka.hideyuki@gmail.com" alt="">tanaka.hideyuki@gmail.com</a><br>2011/12/08&nbsp;@PFIセミナー</p></article><article class="current"><h3>自己紹介</h3><ul><li><p>田中英行&nbsp;(@tanakh,&nbsp;<a href="http://tanakh.jp/" alt="">http://tanakh.jp</a>)</p></li><li>PFI社でプログラマやってます<ul><li><a href="http://jubat.us/" alt="">Jubatus</a></li><li><a href="https://github.com/pfi/pficommon" alt="">pficommon</a></li><li>検索エンジンのコアエンジン</li></ul></li><li>Haskell愛好家<ul><li><a href="http://hackage.haskell.org/package/msgpack" alt="">msgpack</a>&nbsp;/&nbsp;rpc&nbsp;/&nbsp;idl</li><li><a href="http://tanakh.github.com/Peggy/" alt="">peggy</a>&nbsp;(パーザジェネレータ&nbsp;&amp;&nbsp;QQ&nbsp;w/&nbsp;AQ)</li><li><a href="http://hackage.haskell.org/package/Shu-thing" alt="">Shu-thing</a>&nbsp;(シューティングゲーム)&nbsp;/&nbsp;(<a href="http://hackage.haskell.org/package/Monadius" alt="">Monadius</a>&nbsp;メンテナ)</li><li>今気になるパッケージは&nbsp;<a href="http://hackage.haskell.org/package/monad-control" alt="">monad-control</a></li><li><a href="http://learnyouahaskell.com/" alt="">Learn&nbsp;you&nbsp;a&nbsp;Haskell</a>&nbsp;鋭意翻訳中&nbsp;（春頃発売予定）</li></ul></li></ul><div style="position:absolute; top:350px; left:650px;"><img src="pfi-seminar-2011-12-08_files/41JyzF1dU4L.jpg" width="240px"></div>
</article><article class="next"><h2>エラー処理を<strong>書い</strong>てはいけない</h2></article><article class="far-next"><h3>本日の概要</h3><p>エラー処理を抽象化しようというお話です</p><ul><li>現在のエラー処理の抱える問題</li><li>どのように解決するのか</li><li>実際の例</li></ul></article><article class=""><h3>エラーは処理しなければならない</h3><br>&nbsp;<br>&nbsp;<br><center>エラー処理を書いてはいけない</center>
<br><center>≠</center>
<br><center>エラー処理をしてはいけない</center>
<br>&nbsp;<br>&nbsp;<br><center>(※もちろん、エラーを処理する必要はあります)</center>
</article><article class=""><h3></h3><div style="position:absolute; top:300px; left:400px;"><font size="70px"><center><strong><em>??</em></strong></center></font></div>
</article><article class=""><h3>つまりどうしろと？</h3><p>エラー処理を書かずにエラーを処理しろということなんだよ！！！</p></article><article class=""><h3>cf.&nbsp;書いてはいけないシリーズ</h3><ul><li>リソース開放を書いてはいけない</li><li>ロック処理を書いてはいけない</li><li>エラー処理を書いてはいけない&nbsp;←&nbsp;New！</li></ul></article><article class=""><h3>リソース開放を書いてはいけない<br>（認知度：高）</h3><ul><li>malloc&nbsp;/&nbsp;free,&nbsp;new&nbsp;/&nbsp;delete<ul><li>Garbage&nbsp;Collection</li></ul></li><li>fopen&nbsp;/&nbsp;fclose,&nbsp;etc...<ul><li>STL&nbsp;その他</li><li>スコープ・デストラクタを用いた管理</li><li>RAII&nbsp;イディオム</li></ul></li></ul></article><article class=""><h3>ロック処理を書いてはいけない<br>（認知度：中）</h3><ul><li>今すぐロックを使うのを止めるべき5つの理由<ul><li><a href="http://www.slideshare.net/pfi/ss-9780450" alt="">http://www.slideshare.net/pfi/ss-9780450</a></li></ul></li><li>代替<ul><li>STM</li><li>メッセージパッシング</li><li>Concurrent&nbsp;Revisions,&nbsp;etc...</li></ul></li></ul></article><article class=""><h3>エラー処理を書いてはいけない<br>（認知度：？）</h3><ul><li>他にこういうことを主張しているのを聞いたことはない</li></ul><br><ul><li>なんで書いちゃダメなのか？</li><li>代替はあるのか？</li></ul></article><article class=""><h3>ときにに現代社会&nbsp;――</h3><ul><li>エラー処理は&nbsp;ー<ul><li>面倒</li><li>楽しくない</li><li>忘れがち</li></ul></li><li>結果として…</li></ul><br><center><strong>エラー処理をきっちり書く人は良いプログラマ</strong></center>
</article><article class=""><h3>でも、そんなことはない</h3><ul><li>エラー処理は<ul><li>定型的になりがち</li><li>毎回同じことの繰り返し</li><li>忘れがち</li></ul></li><li>じゃあどうするのか？<ul><li>忘れないように気をつける<ul><li>まちがい</li></ul></li><li>抽象化を考える<ul><li>せいかい！</li></ul></li></ul></li></ul></article><article class=""><h2>エラーにまつわるエトセトラ</h2></article><article class=""><h3>エラー処理とはなんなのか？</h3><ul><li>エラー処理と一口に言っても&nbsp;--<ul><li>そもそもエラーとは何か？</li><li>エラー処理とは何か？</li><li>どうなればいいのか？</li></ul></li></ul></article><article class=""><h3>エラーとは何か？</h3><ul><li>何らかの理由で、要求されたタスクを完了出来なかった<ul><li>ハードウェアのエラー</li><li>リソースの不足</li><li>入力のエラー</li><li>プログラムのバグ(assertion&nbsp;failure)</li></ul></li><li>何をエラーにするべきか、せざるべきか<ul><li>mapのキーが無いときとか</li><li>parse&nbsp;error&nbsp;とか</li></ul></li><li>流派<ul><li>エラーは本当にエラーの時にだけ使うべき派</li><li>何でもエラーにしていいんだよ派</li></ul></li></ul></article><article class=""><h3>エラー処理に必要なこと</h3><ul><li>エラーを処理できなければならない<ul><li>何らかの形でエラーを処理できる情報を返す</li></ul></li><li>必要な情報<ul><li>エラーが発生したかどうか（最重要）</li><li>エラーの原因（無いと困る）</li><li>エラーの発生場所（あると嬉しい）</li><li>etc,&nbsp;...</li></ul></li></ul></article><article class=""><h3>エラー通知あれこれ</h3><ul><li>intの返り値としてエラーを返す<ul><li>Cのライブラリの大半</li></ul></li><li>返り値をnullableな型にして、エラー時にnullを返す<ul><li>fopen,&nbsp;java.util.Map.get()&nbsp;など</li></ul></li><li>返り値をエラーとのタプルにする<ul><li>go言語など</li></ul></li><li>返り値をエラーとの直和型にする<ul><li>HaskellのEither型など</li></ul></li><li>オブジェクトをエラー状態にする<ul><li>STLのstreamなど</li></ul></li><li>例外を投げる<ul><li>最近の言語のライブラリの大半</li></ul></li></ul></article><article class=""><h3>intの返り値としてエラーを返す</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode cpp"><span class="dt"><span class="kwd">int</span></span><span class="pln"> foo</span><span class="pun">(...)</span><br><span class="pun">{</span><br><span class="pln">  </span><span class="dt"><span class="kwd">int</span></span><span class="pln"> fd </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="kw"><span class="kwd">return</span></span><span class="pln"> </span><span class="pun">-</span><span class="dv"><span class="lit">1</span></span><span class="pun">;</span><br><span class="pln">  </span><span class="dt"><span class="kwd">int</span></span><span class="pln"> fe </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fe </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    close</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">);</span><br><span class="pln">    </span><span class="kw"><span class="kwd">return</span></span><span class="pln"> </span><span class="pun">-</span><span class="dv"><span class="lit">1</span></span><span class="pun">;</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pln">  </span><span class="dt"><span class="kwd">int</span></span><span class="pln"> ff </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">ff </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    close</span><span class="pun">(</span><span class="pln">fe</span><span class="pun">);</span><br><span class="pln">    close</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">);</span><br><span class="pln">    </span><span class="kw"><span class="kwd">return</span></span><span class="pln"> </span><span class="pun">-</span><span class="dv"><span class="lit">1</span></span><span class="pun">;</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pln">  </span><span class="pun">...</span><br><span class="pun">}</span></code></pre>
</article><article class=""><h3>Pros&nbsp;and&nbsp;Cons</h3><ul><li>Pros<ul><li>ちょっと思いつかない</li><li>（非力な言語でも素直に実装できる）</li></ul></li><li>Cons<ul><li>いっぱい</li></ul></li></ul></article><article class=""><h3>Cons</h3><ul><li>返り値をエラーに取られる<ul><li>本来の返り値はポインタで書き込んでもらう</li><li>(Cではあんまり関係ないけど)&nbsp;関数のComposabilityに悪影響</li></ul></li><li>エラーを簡単に無視出来る<ul><li>無視する手間&nbsp;&lt;&lt;&nbsp;処理する手間</li></ul></li><li>エラーの情報を渡しにくい<ul><li>グローバル変数経由&nbsp;(errno@glibc)<ul><li>スレッドセーフティに影響</li><li>intのエラー番号の管理ェ…</li></ul></li><li>オブジェクトにエラー情報持たせる</li></ul></li></ul></article><article class=""><h3>なぜか&nbsp;goto&nbsp;論争に発展</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode cpp"><span class="dt"><span class="kwd">int</span></span><span class="pln"> foo</span><span class="pun">()</span><br><span class="pun">{</span><br><span class="pln">  </span><span class="dt"><span class="kwd">int</span></span><span class="pln"> fd </span><span class="pun">=</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">,</span><span class="pln"> fe </span><span class="pun">=</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">,</span><span class="pln"> ff </span><span class="pun">=</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">;</span><br><span class="pln">  fd </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="kw"><span class="kwd">goto</span></span><span class="pln"> </span><span class="kwd">finally</span><span class="pun">;</span><br><span class="pln">  fe </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fe </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="kw"><span class="kwd">goto</span></span><span class="pln"> </span><span class="kwd">finally</span><span class="pun">;</span><br><span class="pln">  ff </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(...);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">ff </span><span class="pun">&lt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> </span><span class="kw"><span class="kwd">goto</span></span><span class="pln"> </span><span class="kwd">finally</span><span class="pun">;</span><br><br><span class="pln">  </span><span class="pun">...</span><br><br><span class="kwd">finally</span><span class="pun">:</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fd </span><span class="pun">&gt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> close</span><span class="pun">(</span><span class="pln">fd</span><span class="pun">);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">fe </span><span class="pun">&gt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> close</span><span class="pun">(</span><span class="pln">fe</span><span class="pun">);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(</span><span class="pln">ff </span><span class="pun">&gt;</span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">)</span><span class="pln"> close</span><span class="pun">(</span><span class="pln">ff</span><span class="pun">);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">return</span></span><span class="pln"> </span><span class="pun">-</span><span class="dv"><span class="lit">1</span></span><span class="pun">;</span><br><span class="pun">}</span></code></pre>
</article><article class=""><h3>実際の例</h3><ul><li>Linuxのソースコードなどを読むと、&nbsp;このアプローチがどれだけ大変なことかは解るはず</li></ul></article><article class=""><h3>エラー時にnullを返す</h3><ul><li>Pros<ul><li>一般的なオブジェクト指向言語は、&nbsp;基本的に全てのオブジェクトへの参照が&nbsp;nullable&nbsp;であるため、&nbsp;エラー通知を行うために返り値を変える必要がない</li></ul></li><li>Cons<ul><li>これも無視しやすい<ul><li>ぬるぽっ！</li></ul></li><li>返り値として&nbsp;null&nbsp;が返る可能性があるか、&nbsp;ドキュメントを確認しないといけない</li><li>エラー情報を付加しづらい</li></ul></li></ul></article><article class=""><h3>返り値をエラーとのタプルにする</h3><ul><li>Pros<ul><li>エラー情報をリッチにできる</li><li>比較的エラーを無視しづらい</li></ul></li><li>Cons<ul><li>エラー処理の記述の煩雑さは相変わらず</li><li>エラー時の返り値、正常時のエラー値&nbsp;が存在する必要</li></ul></li></ul></article><article class=""><h3>返り値をエラーとの直和型にする</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">parseCXX </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="dt"><span class="typ">Either</span></span><span class="pln"> </span><span class="dt"><span class="typ">ParseError</span></span><span class="pln"> </span><span class="dt"><span class="typ">Syntax</span></span><br><span class="pln">parseCXX </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="fu"><span class="pun">...</span></span><br><br><span class="pln">foo str </span><span class="fu"><span class="pun">=</span></span><br><span class="pln">  </span><span class="kw"><span class="kwd">case</span></span><span class="pln"> parseCXX str </span><span class="kw"><span class="pln">of</span></span><br><span class="pln">    </span><span class="kw"><span class="typ">Left</span></span><span class="pln"> err </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="fu"><span class="pln">error</span></span><span class="pln"> </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="fu"><span class="pln">show</span></span><span class="pln"> err</span><br><span class="pln">    </span><span class="kw"><span class="typ">Right</span></span><span class="pln"> ast </span><span class="ot"><span class="pun">-&gt;</span></span><br><span class="pln">      </span><span class="kw"><span class="kwd">case</span></span><span class="pln"> syntaxAnal ast </span><span class="kw"><span class="pln">of</span></span><br><span class="pln">        </span><span class="kw"><span class="typ">Left</span></span><span class="pln"> err </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="fu"><span class="pln">error</span></span><span class="pln"> </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="fu"><span class="pln">show</span></span><span class="pln"> err</span><br><span class="pln">        </span><span class="kw"><span class="typ">Right</span></span><span class="pln"> code </span><span class="ot"><span class="pun">-&gt;</span></span><br><span class="pln">          </span><span class="fu"><span class="pun">...</span></span></code></pre>
</article><article class=""><h3>Pros&nbsp;and&nbsp;Cons</h3><ul><li>Pros<ul><li>エラーを(意図的にじゃないと)無視できない</li></ul></li><li>Cons<ul><li>エラー処理が依然煩雑</li></ul></li></ul></article><article class=""><h3>オブジェクトをエラー状態にする</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode cpp"><span class="dt"><span class="kwd">int</span></span><span class="pln"> main</span><span class="pun">(</span><span class="dt"><span class="kwd">int</span></span><span class="pln"> argc</span><span class="pun">,</span><span class="pln"> </span><span class="dt"><span class="kwd">char</span></span><span class="pln"> </span><span class="pun">*</span><span class="pln">argv</span><span class="pun">)</span><br><span class="pun">{</span><br><span class="pln">  ifstream ifs</span><span class="pun">(</span><span class="pln">argv</span><span class="pun">[</span><span class="dv"><span class="lit">1</span></span><span class="pun">]);</span><br><span class="pln">  vector</span><span class="str">&lt;</span><span class="dt"><span class="str">uint8_t</span></span><span class="str">&gt;</span><span class="pln"> buf</span><span class="pun">(</span><span class="dv"><span class="lit">100</span></span><span class="pun">);</span><br><span class="pln">  ifs</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(&amp;</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="dv"><span class="lit">100</span></span><span class="pun">);</span><br><span class="pln">  </span><span class="kw"><span class="kwd">if</span></span><span class="pln"> </span><span class="pun">(!</span><span class="pln">ifs</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    </span><span class="co"><span class="com">// error is occured!!</span></span><br><span class="pln">    </span><span class="pun">...</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pln">  </span><span class="kw"><span class="kwd">return</span></span><span class="pln"> </span><span class="dv"><span class="lit">0</span></span><span class="pun">;</span><br><span class="pun">}</span></code></pre>
</article><article class=""><h3>Pros&nbsp;and&nbsp;Cons</h3><ul><li>Pros<ul><li>エラーを返さずにエラーを通知できる</li><li>エラーをまとめて処理できる</li><li>これは本当に利点か？</li></ul></li><li>Cons<ul><li>エラーを簡単に無視出来る</li><li>そもそも関数がエラーを起こすのかどうかわかり辛い</li><li>エラーをまとめて処理すると、エラーを起こした場所を特定しづらい</li></ul></li></ul><p>初心者にはオススメしない…&nbsp;（例外が使えない環境での苦肉の策として用いられることが多いか）</p></article><article class=""><h3>例外を投げる</h3><ul><li>最近の言語のライブラリの大半</li><li>いろいろな実装がありますが、&nbsp;大半は&nbsp;throw&nbsp;で例外オブジェクトを投げて、&nbsp;catchで拾う形</li></ul></article><article class=""><h3>Pros&nbsp;and&nbsp;Cons</h3><ul><li>Pros<ul><li>（意図的に握りつぶさない限り）エラーを無視できない</li><li>エラー処理を正常時のルーチンから分離できるのでコードの見通しが良くなる</li><li>かなりの定形的なコードを書かなくてよくなる<ul><li>RAIIとともに用いる</li><li>Javaとかでは、try&nbsp;-&nbsp;finallyのネスト…</li></ul></li></ul></li><li>Cons<ul><li>例外安全性を守る必要がある<ul><li>みんなが守るのは難しい</li><li>慣れてる人でもパッと見では判断しかねる</li></ul></li><li>これが難しすぎる</li></ul></li></ul></article><article class=""><h3>例外安全性</h3><p>例外が起こっても、プログラムの実行が<strong>おかしく</strong>ならないという性質</p><ul><li>強い例外安全性<ul><li>例外が発生した場合、全てのデータは元に戻る</li></ul></li><li>基本例外安全性<ul><li>例外が発生しても、システムがクラッシュしない、リソースがリークしない、オブジェクトが無効な状態にならない</li></ul></li><li>(例外中立性)<ul><li>呼び出し先が例外を発生させたときに&nbsp;それを握りつぶさない</li></ul></li></ul></article><article class=""><h3>全人類が読むべき本：堂々の第一位</h3><p><img src="pfi-seminar-2011-12-08_files/kinaba0.png" alt="" class="centered"></p><p><img src="pfi-seminar-2011-12-08_files/kinaba2.png" alt="" class="centered"></p></article><article class=""><h3>Exceptional&nbsp;C++&nbsp;を何故読まねばならないのだろうか？</h3><ul><li><p>（Exceptional&nbsp;C++&nbsp;は例外のみを解説した本ではありませんが）&nbsp;例外安全性についてきちんと述べられていて広く読まれている本</p></li><li><p>近代的プログラミング言語において、&nbsp;例外がエラー通知手段としての事実上のデファクトになっている現代社会においては&nbsp;例外安全性の理解が極めて重要</p></li></ul></article><article class=""><h3>例外安全はむずかしいのです</h3><p>Exceptionalで読むまで全く気づきもしませんでした。</p><p><img src="pfi-seminar-2011-12-08_files/kinaba1.png" alt="" class="centered"></p><ul><li>これは知っていればいいというたぐいの問題でもない<ul><li>例外安全性の保証が&nbsp;書けるプログラムを制限するというのが問題</li></ul></li></ul></article><article class=""><h3>Javaのthrows問題</h3><ul><li>JavaのthrowsはComposabilityを損なう</li></ul>
<pre class="noprettyprint sourceCode"><code class="sourceCode cpp"><span class="kw"><span class="kwd">template</span></span><span class="pln"> </span><span class="pun">&lt;</span><span class="kw"><span class="kwd">class</span></span><span class="pln"> F</span><span class="pun">&gt;</span><br><span class="dt"><span class="kwd">void</span></span><span class="pln"> foo</span><span class="pun">(</span><span class="pln">F f</span><span class="pun">)</span><br><span class="pun">{</span><br><span class="pln">  f</span><span class="pun">();</span><br><span class="pun">}</span></code></pre>
<p>このようなものがJavaで書けるか？&nbsp;（throwsに何を書けばいいのか）</p><ul><li>Scalaではthrowsを取り去るという判断</li></ul></article><article class=""><h3>エラー処理いろいろありますが…</h3><ul><li>やはり銀の弾丸は無い</li><li>しかし、我々は改善策を見つけることはできるはず</li></ul></article><article class=""><h2>書かないエラー処理</h2></article><article class=""><h3>書かないエラー処理とは</h3><ul><li>エラー処理というのはたいてい毎回似通うもの</li><li>ならば1回書いてそれを使いまわせるはずじゃあないか！</li></ul></article><article class=""><h3>DRY</h3><br>&nbsp;<br><center><strong><em>Don't</em></strong></center><br><center><strong><em>Repeat</em></strong></center><br><center><strong><em>Yourself</em></strong></center>
</article><article class=""><h3>何故か抽象化されない</h3><ul><li><p>例外からあまり進展が見られない</p></li><li>例外を使いやすくするツールたち<ul><li>scope&nbsp;&amp;&nbsp;destructor&nbsp;(C++)</li><li>using&nbsp;(C#),&nbsp;Java7&nbsp;の&nbsp;try</li><li>bracket&nbsp;(scheme,&nbsp;Ruby,&nbsp;Haskell,&nbsp;...)</li></ul></li><li><p>包括的に扱うツールは？</p></li></ul></article><article class=""><h3>気を付けなければならない<br>⇔間違える</h3><p>気を付けなければならないということは&nbsp;必ずミスを犯すということ</p><ul><li>メモリを解放するのを気を付けなければならない<ul><li>メモリリーク</li></ul></li><li>ロックを獲得する際は気を付けなければならない<ul><li>デッドロック</li></ul></li><li>例外安全性に気を付けなければならない<ul><li>死亡</li></ul></li></ul></article><article class=""><h3>バグを潰す<br>&nbsp;⇒&nbsp;バグをジェノサイドする</h3><ul><li>一つ一つバグを倒すのはとっても不毛な作業<ul><li>だけど、プログラミングにはジェノサイドの巻物が存在する！</li></ul></li><li>メモリリークをジェノサイド&nbsp;-&gt;&nbsp;GC</li><li><p>デッドロックをジェノサイド&nbsp;-&gt;&nbsp;STM</p></li><li><p>エラー処理にまつわるバグをジェノサイド&nbsp;-&gt;&nbsp;???</p></li></ul><div style="position:absolute; top:450px; left:550px;"><img src="pfi-seminar-2011-12-08_files/jeno.jpg" width="280px"></div>
</article><article class=""><h3>大まかなアプローチ</h3><p>エラー生成&nbsp;&lt;-&gt;&nbsp;利用する関数&nbsp;&lt;-&gt;&nbsp;エラー処理&nbsp;これらを分離する</p><ul><li>エラー生成（フロントエンド）</li><li>エラー処理（バックエンド）</li><li>アプリ</li></ul><p>エラー生成関数を利用する関数もまたエラー生成関数へ。</p><p>任意のエラー生成関数に対してエラーを処理できるバックエンドを&nbsp;たった一回実装。</p></article><article class=""><h3></h3><br>&nbsp;<br>&nbsp;<br>&nbsp;<br>&nbsp;<br><center>そんな事出来るんですか？</center>
</article><article class=""><h3>できるんです。</h3><br>&nbsp;<br>&nbsp;<br>&nbsp;<br>&nbsp;<br><center><strong>そう、Haskellならね。</strong></center>
</article><article class=""><h2>Haskellでのエラー処理</h2></article><article class=""><h3>Haskellでのエラー通知手段あれこれ</h3><ul><li>返り値をエラーとして返す<ul><li>あまりやられない<ul><li>Cと違い返り値を返す手段がなくなるから？</li></ul></li></ul></li><li>返り値をnullableな型にして、エラー時にnullを返す<ul><li>Maybe&nbsp;a</li></ul></li><li>返り値をエラーとのタプルにする<ul><li>あまりやられない（メリットがない）</li></ul></li><li>返り値をエラーとの直和型にする<ul><li>Either&nbsp;Error&nbsp;a</li></ul></li><li>例外を投げる<ul><li>IO&nbsp;a</li></ul></li></ul></article><article class=""><h3>実はどれも同じように扱える</h3><p>どれをつかってもいいんです。&nbsp;モナドのフレームワークを使えば。</p><ul><li>床下配線のアナロジー</li></ul><p>異なるエラー型ごとに、床下の配線を（コンパイラが）組み替える</p><p><img src="pfi-seminar-2011-12-08_files/yuka.jpg" alt="" class="centered"></p></article><article class=""><h3>エラー処理を書いてみる&nbsp;：&nbsp;Maybe</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="pln">extractJson json </span><span class="fu"><span class="pun">=</span></span><br><span class="pln">  </span><span class="kw"><span class="pln">let</span></span><span class="pln"> mbusr </span><span class="fu"><span class="pun">=</span></span><span class="pln"> lookupJson json </span><span class="st"><span class="str">"user"</span></span><span class="pln"> </span><span class="kw"><span class="kwd">in</span></span><br><span class="pln">  </span><span class="kw"><span class="kwd">case</span></span><span class="pln"> mbusr </span><span class="kw"><span class="pln">of</span></span><br><span class="pln">    </span><span class="kw"><span class="typ">Nothing</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="kw"><span class="typ">Nothing</span></span><br><span class="pln">    </span><span class="kw"><span class="typ">Just</span></span><span class="pln"> usr </span><span class="ot"><span class="pun">-&gt;</span></span><br><span class="pln">      </span><span class="kw"><span class="pln">let</span></span><span class="pln"> mbmeta </span><span class="fu"><span class="pun">=</span></span><span class="pln"> lookupJson usr </span><span class="st"><span class="str">"meta"</span></span><span class="pln"> </span><span class="kw"><span class="kwd">in</span></span><br><span class="pln">      </span><span class="kw"><span class="kwd">case</span></span><span class="pln"> mbmeta </span><span class="kw"><span class="pln">of</span></span><br><span class="pln">        </span><span class="kw"><span class="typ">Nothing</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="kw"><span class="typ">Nothing</span></span><br><span class="pln">        </span><span class="kw"><span class="typ">Just</span></span><span class="pln"> meta </span><span class="ot"><span class="pun">-&gt;</span></span><br><span class="pln">          </span><span class="kw"><span class="pln">let</span></span><span class="pln"> mbname </span><span class="fu"><span class="pun">=</span></span><span class="pln"> lookupJson user </span><span class="st"><span class="str">"name"</span></span><span class="pln"> </span><span class="kw"><span class="kwd">in</span></span><br><span class="pln">          </span><span class="fu"><span class="pun">...</span></span></code></pre>
</article><article class=""><h3>エラー処理を書いてみる&nbsp;：&nbsp;Maybeモナディック</h3>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="pln">extractJson json </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><br><span class="pln">  user </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> lookupJson json </span><span class="st"><span class="str">"user"</span></span><br><span class="pln">  meta </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> lookupJson json </span><span class="st"><span class="str">"meta"</span></span><br><span class="pln">  name </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> lookupJson json </span><span class="st"><span class="str">"name"</span></span><br><span class="pln">  </span><span class="fu"><span class="pun">...</span></span></code></pre>
<p>モナド使おう！</p></article><article class=""><h3>ここで重要なこと</h3><p>前の例で重要なことは、&nbsp;モナディックに記述してあるので、&nbsp;<strong>Maybeについては一切言及していないということ</strong></p><p><br>&nbsp;　　　⇒</p><p><br>&nbsp;何のエラー表現に対しても使える！</p></article><article class=""><h3>Monad&nbsp;as&nbsp;a&nbsp;Context</h3><ul><li>State&nbsp;モナド<ul><li>状態を持つ能力</li></ul></li><li>Writer&nbsp;モナド<ul><li>ログを書きだす能力</li></ul></li><li>Error&nbsp;モナド<ul><li>エラーを発生・処理する能力</li></ul></li><li>IO&nbsp;モナド<ul><li>C的な能力</li></ul></li></ul></article><article class=""><h3>IOモナドの能力</h3><p>IO&nbsp;モナドチートだった…</p><ul><li>IO&nbsp;モナド<ul><li>IO&nbsp;を行う能力</li><li>メモリを読み書きする能力</li><li>Cの関数を呼び出す能力</li><li>例外を投げる能力</li><li>その他計算機にできることなんでも</li></ul></li></ul></article><article class=""><h3>たまによくある&nbsp;インターフェース</h3><p>IOとMaybeかぶってるよ！</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">getHttp </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="dt"><span class="pln">IO</span></span><span class="pln"> </span><span class="pun">(</span><span class="dt"><span class="typ">Maybe</span></span><span class="pln"> </span><span class="dt"><span class="typ">Response</span></span><span class="pun">)</span><br><span class="pln">getHttp url </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="fu"><span class="pun">...</span></span></code></pre>
<p>こういうのはIOだけで良い</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">getHttp </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> </span><span class="dt"><span class="pln">IO</span></span><span class="pln"> </span><span class="dt"><span class="typ">Response</span></span><br><span class="pln">getHttp url </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="fu"><span class="pun">...</span></span></code></pre>
</article><article class=""><h3>最新のインターフェース</h3><p>最新の手法を用いた定義</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">getHttp </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="pun">(</span><span class="dt"><span class="typ">MonadIO</span></span><span class="pln"> m</span><span class="pun">,</span><span class="pln"> </span><span class="dt"><span class="typ">Failure</span></span><span class="pln"> </span><span class="dt"><span class="typ">HttpError</span></span><span class="pln"> m</span><span class="pun">)</span><span class="pln"> </span><span class="ot"><span class="pun">=&gt;</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> m </span><span class="dt"><span class="typ">Response</span></span></code></pre>
</article><article class=""><h3>エラーを包括的に扱うフレームワーク</h3><ul><li>failure&nbsp;/&nbsp;control-monad-failure<ul><li>エラー表現を統一的に扱うためのインターフェース</li></ul></li><li>monad-control<ul><li>リフトされたモナドをリフト元のモナドで使えるようにするためのインターフェース<ul><li>よくある使い方は、&nbsp;モナドのショートサーキットに対してもbracketが正しく動作できるようにするなど</li></ul></li><li>詳しい話は又の機会に</li></ul></li></ul></article><article class=""><h3>型は雄弁に語る</h3><p>型を見れば何が起こるか大体わかる</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">getHttp </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="pun">(</span><span class="dt"><span class="typ">MonadIO</span></span><span class="pln"> m</span><span class="pun">,</span><span class="pln"> </span><span class="dt"><span class="typ">Failure</span></span><span class="pln"> </span><span class="dt"><span class="typ">HttpError</span></span><span class="pln"> m</span><span class="pun">)</span><span class="pln"> </span><span class="ot"><span class="pun">=&gt;</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><span class="pln"> </span><span class="ot"><span class="pun">-&gt;</span></span><span class="pln"> m </span><span class="dt"><span class="typ">Response</span></span></code></pre>
<ul><li><p>MonadIO&nbsp;m&nbsp;...&nbsp;IOを行う</p></li><li>Failure&nbsp;HttpError&nbsp;...&nbsp;HttpError&nbsp;というエラーを<strong>何らかの手段で</strong>通知する可能性がある<ul><li>何の手段かは指定していない</li><li>Maybeでも、Eitherでも、IOでも</li><li>はたまた将来誰かが作るエラー型でも。</li></ul></li></ul></article><article class=""><h3>使用例</h3><p>IOでも。</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">main </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="pln">IO</span></span><span class="pln"> </span><br><span class="pln">main </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><br><span class="pln">  resp </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> getHttp </span><span class="st"><span class="str">"http://tanakh.jp"</span></span><br><span class="pln">  </span><span class="fu"><span class="pun">...</span></span><br><span class="pln">  </span><span class="ot"><span class="str">`catch`</span></span><span class="pln"> </span><span class="fu"><span class="pun">...</span></span></code></pre>
<p>ErrorT&nbsp;IO&nbsp;でも。</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="pln">main </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><br><span class="pln">  resp </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> runErrorT </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><br><span class="pln">    getHttp </span><span class="st"><span class="str">"http://tanakh.jp"</span></span><br><span class="pln">  </span><span class="fu"><span class="kwd">print</span></span><span class="pln"> resp </span><span class="co"><span class="pun">--</span><span class="pln"> </span><span class="typ">Either</span><span class="pln"> </span><span class="typ">HttpError</span><span class="pln"> </span><span class="typ">Response</span></span></code></pre>
</article><article class=""><h3>モナディックアプローチの良いところ</h3><ul><li><p>古いエラーインターフェースのものも、&nbsp;liftでごたまぜにできる</p></li><li><p>使うときに好きな型を選べる</p></li><li>Alternative&nbsp;と組み合わせられる<ul><li>Failure&nbsp;かつ、Alternativeなエラー表現を選んだ場合</li><li>Maybe,&nbsp;Either,&nbsp;List,&nbsp;IO,&nbsp;...</li></ul></li></ul></article><article class=""><h3>Alternativeとの組み合わせ</h3><p>失敗した時の代替操作とか</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">foo </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="pln">IO</span></span><span class="pln"> </span><span class="dt"><span class="typ">String</span></span><br><span class="pln">foo </span><span class="fu"><span class="pun">=</span></span><span class="pln"> </span><span class="fu"><span class="pln">readFile</span></span><span class="pln"> </span><span class="st"><span class="str">"hoge"</span></span><span class="pln"> </span><span class="fu"><span class="pun">&lt;|&gt;</span></span><span class="pln"> </span><span class="fu"><span class="pln">readFile</span></span><span class="pln"> </span><span class="st"><span class="str">"hoge.exe"</span></span></code></pre>
<p>失敗するまで繰り返すとか</p>
<pre class="noprettyprint sourceCode"><code class="sourceCode haskell"><span class="ot"><span class="pln">bar </span></span><span class="ot"><span class="pun">::</span></span><span class="pln"> </span><span class="dt"><span class="pln">IO</span></span><span class="pln"> </span><span class="pun">[</span><span class="dt"><span class="typ">Int</span></span><span class="pun">]</span><br><span class="pln">bar </span><span class="fu"><span class="pun">=</span></span><span class="pln"> many </span><span class="pun">(</span><span class="fu"><span class="pln">readIO</span></span><span class="pln"> </span><span class="fu"><span class="pun">=&lt;&lt;</span></span><span class="pln"> </span><span class="fu"><span class="pln">getLine</span></span><span class="pun">)</span></code></pre>
</article><article class=""><h3>まとめ</h3><ul><li>intでエラーを返すのはもうやめよう</li><li>モナドを使ったアプローチは非常に簡潔で堅牢</li><li>（モナドが使えないならせめて例外を使おう）</li></ul></article><div id="prev-slide-area" class="slide-area"></div><div id="next-slide-area" class="slide-area"></div></section><link href="pfi-seminar-2011-12-08_files/css.css" type="text/css" rel="stylesheet"><link href="pfi-seminar-2011-12-08_files/styles.css" type="text/css" rel="stylesheet"><script src="pfi-seminar-2011-12-08_files/prettify.txt" type="text/javascript"></script></body></html>
