<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><title>Conduitの今</title><meta charset="utf-8"><script src="yesod-1.0-conduit_files/slides.txt"></script><link rel="stylesheet" href="yesod-1.0-conduit_files/syntax.css"><link rel="stylesheet" href="yesod-1.0-conduit_files/style.css"><meta content="width=1100,height=750" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"></head><body class="loaded" style="display: none;"><section class="slides layout-regular template-pfi"><article class="current"><h1>Conduitの今</h1><p>田中英行&nbsp;<a href="mailto:tanakh@preferred.jp" alt="">tanakh@preferred.jp</a><br>2012/04/22&nbsp;Yesod&nbsp;1.0&nbsp;勉強会</p></article><article class="next"><h3>自己紹介</h3><ul><li>田中英行&nbsp;(@tanakh)</li><li>(株)Preferred&nbsp;Infrastracture&nbsp;研究開発部門<ul><li>社内ライブラリ&nbsp;<em>pficommon</em>&nbsp;<br>&nbsp;<a href="https://github.com/pfi/pficommon" alt="">https://github.com/pfi/pficommon</a></li><li>分散機械学習フレームワーク&nbsp;<em>jubatus</em>&nbsp;<br>&nbsp;<a href="http://jubat.us/" alt="">http://jubat.us/</a></li><li>検索エンジン&nbsp;<em>Sedue</em></li></ul></li><li>Haskell愛好家<ul><li>2003～</li></ul></li><li>Learn&nbsp;You&nbsp;a&nbsp;Haskell&nbsp;for&nbsp;Great&nbsp;Good!<ul><li>訳してます</li><li>近々でます！</li></ul></li></ul></article><article class="far-next"><h2>Conduitとは</h2></article><article><h3>Conduitとは</h3><ul><li>I/O&nbsp;を良い感じにやるためのライブラリ<ul><li>良い感じのストリーミング的なパーザ</li><li>良い感じのバッファの自動管理</li><li>良い感じのFlushing</li><li>良い感じのリソース管理</li></ul></li><li>get&nbsp;rid&nbsp;of&nbsp;lazy-eval<ul><li>遅延I/O&nbsp;は良くない</li><li><a href="http://d.hatena.ne.jp/tanakh/20100824" alt="">http://d.hatena.ne.jp/tanakh/20100824</a>&nbsp;こちらも参照</li></ul></li></ul></article><article><h3>便利なConduit達の例</h3><ul><li>コーデック</li></ul><pre class="sourceCode haskell prettyprint"><code class="sourceCode haskell"><span class="pln">main </span><span class="fu"><span class="pun">=</span></span><span class="pln"> runResourceT </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><span class="pln">
  sourceFile </span><span class="st"><span class="str">"utf8-txt.bz2"</span></span><span class="pln"> </span><span class="fu"><span class="pun">=</span><span class="pln">$</span><span class="pun">=</span></span><span class="pln"> bunzip2 </span><span class="fu"><span class="pun">=</span><span class="pln">$</span><span class="pun">=</span></span><span class="pln"> decode utf8 </span><span class="fu"><span class="pln">$$</span></span><span class="pln"> sinkFile </span><span class="st"><span class="str">"decoded"</span></span></code></pre><ul><li>プロセス</li></ul><pre class="sourceCode haskell prettyprint"><code class="sourceCode haskell"><span class="pln">main </span><span class="fu"><span class="pun">=</span></span><span class="pln"> runResourceT </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><span class="pln">
  sourceCmd </span><span class="st"><span class="str">"ls -alF"</span></span><span class="pln"> </span><span class="fu"><span class="pun">=</span><span class="pln">$</span><span class="pun">=</span></span><span class="pln"> conduitCmd </span><span class="st"><span class="str">"sort"</span></span><span class="pln"> </span><span class="fu"><span class="pln">$$</span></span><span class="pln"> sinkHandle stdout</span></code></pre></article><article><h3>今のConduit</h3><ul><li>唯一の型、Pipe<ul><li>Pipeをつなぐという操作だけ</li></ul></li><li>たった2つの高レベルプリミティブ<ul><li>await&nbsp;-&gt;&nbsp;上流からデータを受け取る</li><li>yield&nbsp;-&gt;&nbsp;下流にデータを流す</li></ul></li><li>すべてがMonad、MonadIO<ul><li>Source、Conduitの中でIOを行うのもとても簡単！</li><li>ハンドルをオープンするPipeとか</li></ul></li></ul></article><article><h3>例</h3><pre class="sourceCode haskell prettyprint"><code class="sourceCode haskell"><span class="pln">idPipe </span><span class="fu"><span class="pun">=</span></span><span class="pln"> forever </span><span class="fu"><span class="pln">$</span></span><span class="pln"> await </span><span class="fu"><span class="pun">&gt;&gt;=</span></span><span class="pln"> </span><span class="kwd">yield</span><span class="pln"> </span><span class="fu"><span class="pun">.</span></span><span class="pln"> fromJust</span></code></pre><pre class="sourceCode haskell prettyprint"><code class="sourceCode haskell"><span class="pln">w8tow16 </span><span class="fu"><span class="pun">=</span></span><span class="pln"> forever </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="kw"><span class="kwd">do</span></span><span class="pln">
  </span><span class="kw"><span class="typ">Just</span></span><span class="pln"> v1 </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> await
  </span><span class="kw"><span class="typ">Just</span></span><span class="pln"> v2 </span><span class="ot"><span class="pun">&lt;-</span></span><span class="pln"> await
  </span><span class="kwd">yield</span><span class="pln"> </span><span class="fu"><span class="pln">$</span></span><span class="pln"> </span><span class="fu"><span class="pln">fromIntegral</span></span><span class="pln"> v1 </span><span class="fu"><span class="pun">*</span></span><span class="pln"> </span><span class="dv"><span class="lit">256</span></span><span class="pln"> </span><span class="fu"><span class="pun">+</span></span><span class="pln"> </span><span class="fu"><span class="pln">fromIntegral</span></span><span class="pln"> v2</span></code></pre></article><article><h3>これまでのあらすじ</h3><ul><li>left-fold&nbsp;enumerator&nbsp;として&nbsp;Iteratee&nbsp;が発明される&nbsp;[Oleg&nbsp;2008]<ul><li><a href="http://okmij.org/ftp/Streams.html" alt="">http://okmij.org/ftp/Streams.html</a></li></ul></li><li>"実用的な"&nbsp;iteratee&nbsp;実装&nbsp;2009-2011<ul><li><a href="http://hackage.haskell.org/package/iteratee" alt="">http://hackage.haskell.org/package/iteratee</a></li><li><a href="http://hackage.haskell.org/package/enumerator" alt="">http://hackage.haskell.org/package/enumerator</a></li></ul></li><li>iterIO,&nbsp;Pipes&nbsp;登場&nbsp;(2011-)<ul><li>iteratee,&nbsp;enumerator,&nbsp;enumeratee&nbsp;の統合</li></ul></li><li>Conduit出現&nbsp;2011-2012<ul><li><a href="http://www.yesodweb.com/blog/2011/12/resourcet" alt="">http://www.yesodweb.com/blog/2011/12/resourcet</a></li></ul></li></ul></article><article><h3>Conduitとは</h3><ul><li>I/O&nbsp;ライブラリ<ul><li>ストリームライブラリ？</li></ul></li><li>Handle&nbsp;I/O<ul><li>Sucks</li></ul></li><li>遅延&nbsp;I/O<ul><li>Harmful</li></ul></li><li>Conduit<ul><li>ユートピア！</li></ul></li></ul></article><article><h3>enumeratorの問題点</h3><ul><li><p>例外安全</p></li><li><p>リソースをちゃんと扱う</p></li><li><p>enumeratee同士を連結できない</p></li><li><strong><em>enumerateeを書くのが難しすぎる</em></strong><ul><li>書いたことある人なら分かるかと思いますが…</li></ul></li></ul></article><article><h3>Conduitの歴史</h3><ul><li>conduit-0.0<ul><li>enumeratee&nbsp;の気に入らない点を修正したりとか</li></ul></li><li>conduit-0.1<ul><li>何だったっけ？</li></ul></li><li>conduit-0.2<ul><li>Sourceがシンプルに</li><li>Sourceがpureに</li></ul></li><li>conduit-0.3<ul><li>Souce,&nbsp;Conduit,&nbsp;Sinkの型が劇的にシンプルに</li></ul></li><li>conduit-0.4<ul><li>Pipe化<ul><li>Source,&nbsp;Conduit,&nbsp;Sink&nbsp;の型が遂に統合</li></ul></li></ul></li></ul></article><article><h3>私とConduit</h3><ul><li>ResourceT、Conduitから分離されへんかなー<ul><li>=&gt;&nbsp;0.3でresourcetパッケージ分離</li></ul></li><li>SouceとConduitがMonad,&nbsp;MonadIOじゃないの辛いなあ、いっそPipeにならないかなあ<ul><li>⇒&nbsp;次の日ConduitがPipeになる</li></ul></li></ul><p><em>*</em>&nbsp;Conduitいいよ！&nbsp;<em>*</em></p></article><article><h3>まとめ</h3><ul><li><p>CPSのコードややこしいし、ユーザにとっては設計どうでもいいし、どうせI/Oに使うのがメインなのだから、副作用を使ってUglyだけどシンプルに行くよ&nbsp;=&gt;&nbsp;Conduit-0.0</p></li><li><p>副作用がない場合にConduitが激遅だよ！やっぱりPureにしよう。コードも意外とシンプルになったね&nbsp;=&gt;&nbsp;Conduit-0.2</p></li><li><p>Result型とかいらなかったね。あれ、3つの型が似てきた？Pipe？あれはダメだね&nbsp;=&gt;&nbsp;Conduit-0.3</p></li><li><p>Pipe素晴らしい！&nbsp;=&gt;&nbsp;Conduit-0.4</p></li></ul></article><article><h3>まとめのまとめ</h3><ul><li><p>今のConduitはPipeとかなり似ている</p></li><li><p>リソース管理モナドの外付けによるリソース管理</p></li></ul></article><article><h2>Conduit&nbsp;これから</h2></article><article><h3>私とConduitその2</h3><ul><li>Conduit入力消費するたびにリリーサが膨れるなー<ul><li>Issue登録</li><li>Snoymanさん（Conduit作者）登場</li><li>解決！（この間わずか2時間）</li><li>=&gt;&nbsp;0.4.1に</li></ul></li><li>Conduit（Pipeモナド）遅いなー<ul><li>次の日、rewriteブランチが出来てた</li><li>すごい！</li></ul></li><li>Snoymanさんはエスパーか！？</li></ul></article><article><h3>次来る機能？（個人的に欲しい機能）</h3><ul><li>Fusion<ul><li>Conduitの連結が長くなっても、オーバーヘッド0で</li><li>rewriteブランチを生暖かくウォッチ中</li></ul></li><li>ListLikeに？<ul><li>出来るんじゃないのかなあ</li><li>なると嬉しいなあ</li></ul></li><li>Category&nbsp;インスタンス<ul><li>明らかにPipeは圏である</li><li>pipesパッケージではCategoryのインスタンス</li><li>Snoymanさんは、圏とかどうでもいいと仰っていますが…</li></ul></li></ul></article><div id="prev-slide-area" class="slide-area"></div><div id="next-slide-area" class="slide-area"></div></section><link href="yesod-1.0-conduit_files/css.css" type="text/css" rel="stylesheet"><link href="yesod-1.0-conduit_files/styles.css" type="text/css" rel="stylesheet"><script src="yesod-1.0-conduit_files/prettify.txt" type="text/javascript"></script></body></html>